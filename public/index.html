<script>

let dataStore = {};
let activeTag = null;
let currentVideos = {};
let firstLoad = true;
let seenVideos = new Set(); // ðŸ”¥ track semua video yang pernah muncul

async function loadLive(){
  const res = await fetch("/api/live");
  const newData = await res.json();

  dataStore = newData;

  renderTabs();

  if(activeTag){
    showCategory(activeTag);
  }

  // ðŸ”¥ setelah render, baru cek notifikasi
  if(!firstLoad){
    checkNewLive();
  }

  firstLoad = false;
}

function checkNewLive(){

  Object.keys(dataStore).forEach(tag => {

    const videos = dataStore[tag] || [];

    videos.forEach(video => {

      // ðŸ”¥ hanya notif jika belum pernah terlihat sama sekali
      if(!seenVideos.has(video.videoId)){
        showNotification("ðŸ”´ Live baru di #" + tag.toUpperCase(), tag);
        seenVideos.add(video.videoId);
      }

    });
  });
}

function showNotification(message, tag){

  const notif = document.createElement("div");
  notif.className = "notification";
  notif.innerText = message;

  notif.onclick = () => {
    activeTag = tag;
    showCategory(tag);
    updateActiveTab();
    notif.remove();
  };

  document.body.appendChild(notif);

  setTimeout(()=> notif.remove(), 4000);
}

function renderTabs(){
  const tabs = document.getElementById("tabs");
  tabs.innerHTML = "";

  Object.keys(dataStore).forEach((tag, index) => {

    const btn = document.createElement("div");
    btn.className = "tab";
    btn.innerText = tag.toUpperCase();

    btn.onclick = () => {
      activeTag = tag;
      showCategory(tag);
      updateActiveTab();
    };

    if(index === 0 && !activeTag){
      activeTag = tag;
    }

    tabs.appendChild(btn);
  });

  updateActiveTab();
}

function updateActiveTab(){
  document.querySelectorAll(".tab").forEach(tab=>{
    tab.classList.remove("active");
    if(tab.innerText.toLowerCase() === activeTag){
      tab.classList.add("active");
    }
  });
}

function showCategory(tag){

  const grid = document.getElementById("grid");
  const videos = dataStore[tag] || [];

  let newVideoMap = {};

  videos.forEach(video => {

    newVideoMap[video.videoId] = video;

    // ðŸ”¥ tambahkan ke seenVideos saat pertama kali muncul
    if(!seenVideos.has(video.videoId)){
      seenVideos.add(video.videoId);
    }

    if(document.getElementById("video-" + video.videoId)){
      return;
    }

    const card = document.createElement("div");
    card.className = "card";
    card.id = "video-" + video.videoId;

    card.innerHTML = `
      <iframe src="https://www.youtube.com/embed/${video.videoId}?autoplay=1&mute=1"
              allowfullscreen></iframe>

      <div class="info">
        <div class="channel">${video.channelTitle}</div>
        <div>${video.title}</div>
      </div>
    `;

    grid.appendChild(card);
  });

  Object.keys(currentVideos).forEach(id => {
    if(!newVideoMap[id]){
      const el = document.getElementById("video-" + id);
      if(el){
        el.classList.add("fade-out");
        setTimeout(() => el.remove(), 600);
      }
    }
  });

  currentVideos = newVideoMap;
}

loadLive();
setInterval(loadLive, 60000);

</script>
